## Linux time system
### 能产生时钟信号的设备
* RTC `Real-Time Clock`实时时钟,独立于CPU集成在主板芯片上,Linux只用这个设备获取时间和日期.
* TSC `Time Stamp Counter` 时间计数器,x86处理器有一条CLK输入引线,接收外部振荡器的信号,每次收到信号就加1.

Linux使用这个计数器用来计算CPU频率,例如2.4GHZ的CPU每秒震荡2.4*10^6,内核会在5ms内检查计数器的增量来进行计算.

* PIT `Programmable interval Timer`可编程间隔定时器,这个设备发出一个特殊中断`timer interrupt`时钟中断.

在Linux中PIT以内核确定的一个频率向IRQ0发出时钟中断,这个频率根据CPU架构和内核版本的不同而不同,在x86,2.6内核的Linux中,频率是1000HZ,即1ms一次中断.可以用以下命令查看
```
cat /boot/config-2.6.x|grep CONFIG_HZ
```

* 本地APIC定时器，为了发挥SMP体系的并行性,Intel引入了`I/O Advanced Programmable Interrupt Controller`IO高级可编程中断控制器,每个CPU有自己的本地 APIC,所有本地 APIC 通过系统总线连接到 I/O APIC.

本地APIC有自己的定时器,只能由一个CPU使用,频率是基于总线的时钟信号
* HPET `High Precision Event Time`高精度事件定时器,由Intel和Microsoft联合开发的新型定时器芯片,用于PC机.集成在芯片组中

* ACPI PMT
`Advanced Configuration and Power Interface`高级配置与电源接口`Power Management Timer`高级管理定时器,所有支持ACPI的主板都有这个定时器,一般是3.85MHz的固定频率

## Linux kernel 计时器
### 低精度定时器
内核里有一个32位有符号值jiffies,用来记录启动以来时钟中断次数,x64里是64位的低32位,每次时钟中断jiffies就加1

### 时间轮
从 Linux2.4 开始，内核通过一种被称为时间轮的算法来保证 add_timer()、del_timer() 以及 expire 处理操作的时间复杂度都为 O(1).
一个数组bukket,每个元素bukket[i]代表i秒后,是一个链表,链表内是定时器.

## 高精度定时器
高精度定时器由红黑树管理，而非时间轮



## function


```c
#include <time.h>
#include <stdio.h>
#include <stdlib.h>

void time_ctime(){
  time_t t;
  time(&t);  // 1970/1/1 00:00:00 到现在的秒数

  printf("Time is: %d\n", t);
  printf("Ctime is: %s\n", ctime(&t));
}

void time_localtime() {
  time_t t;
  struct tm * time_struct;
  time(&t);

  char buf [100];
  time_struct = localtime(&t);
  strftime(buf,100,"It is now: %I:%M %p\n",time_struct);
  puts(buf);
  
}

void get_time_of_day() {
  // 高精度
  struct timeval tv; //stdlib.h
  gettimeofday(&tv,NULL); // 1970/1/1 00:00:00 到现在的微秒数
  printf("High Time: %d.%d\n",tv.tv_sec,tv.tv_usec); 

}

#define rdtsc(low,high) __asm__ \
 __volatile__("rdtsc" : "=a" (low), "=d" (high))

void no_system_call() {
  // 高精度,避免gettimeofday系统调用
  // 读取 x86 TSC 设备
  unsigned low, high;
  rdtsc(low,high)
  unsigned long long cycles; // cpu 周期
  cycles = high;
  cycles = (cycles << 32) | low; //将 low 和 high 合成一个 64 位值
  
  float hz = 2127.985 // cup hz, get it in /proc/cpuinfo
}
```

# 参考
http://www.ibm.com/developerworks/cn/linux/1308_liuming_linuxtime4/

http://www.ibm.com/developerworks/cn/linux/1307_liuming_linuxtime1/
